Условия домашки
Что нужно сделать
Продолжаем работать над приложением интернет-магазина.

На этом этапе вы добавите корзину для товаров, научитесь добавлять туда товар и выводить ее содержимое. Корзину мы сделаем уникальной для каждого пользователя интернет-магазина с помощью бина со специальным скоупом.

Выполните эту работу в проекте предыдущего урока.

Шаг 1. Добавление компонента корзины
Корзина будет представлять из себя
@SessionScope
. Компонент внутри будет содержать только
Map
с
id
товара в качестве ключа и
Integer
в качестве значения.
Integer
нам нужен, так как один товар можно добавлять в корзину несколько раз.

Создайте класс
ProductBasket
в подпакете
model.basket
с
private final
полем с мапой товаров и их количеством и двумя методами:

Метод добавления продукта в корзину. Он будет принимать
UUID id
и не будет ничего возвращать.
Метод получения всех продуктов, которые сейчас есть в корзине. Он должен возвращать ту же мапу
Map<UUID, Integer>
, которая хранится в поле. Чтобы защитить нас от возможных изменений этой мапы, нужно обернуть ее в
Collections.unmodifiableMap
.
Шаг 2. Сервис работы с корзиной
Этот сервис будет объединять наш новый компонент с контроллером и позволит нам добавлять в корзину товары и показывать текущее состояние корзины пользователю.

Создайте класс
BasketService
в пакете
service
. В этом классе нам нужны два
private final
поля. Одно поле будет содержать наш компонент корзины, а второе —
StorageService
. Эти поля нужно инициализировать через конструктор, как обычно, используя
constructor injection
.

Класс сервиса должен содержать два метода:

Метод добавления товара в корзину по
id
.
Этот метод должен принимать
UUID id
и ничего не возвращать. Внутри метода вам нужно обратиться к
StorageService
и проверить, есть ли переданный в аргументах
id
в списке продуктов.

Для этого допишите метод в
StorageService
, который получает продукт по
id
и возвращает
Optional<Product>
.

public Optional<Product> getProductById(UUID id) {
return Optional.ofNullable(availableProducts.get(id));
}
После этого в теле метода вы обращаетесь к
storage service
, получаете
Optional
и, если он пустой (
isPresent == false
), то вам нужно выбросить
IllegalArgumentException()
.

Если же такой товар есть в
StorageService
, то достаточно добавить его в корзину, обратившись к ее компоненту.

Метод отображения корзины пользователю.
Чтобы написать этот метод, вам нужно сделать подготовительную работу. Вам потребуется объект, представляющий корзину в виде
JSON
-объекта, чтобы показать его пользователю. Если мы будем просто отправлять
Map<UUID, Integer>
пользователю, то будет непонятно, какая стоимость корзины и какие продукты были добавлены.

Для этого создадим несколько классов:


BasketItem
— немодифицируемый класс с двумя полями —
Product
и его количество(
int
).

UserBasket
— класс, представляющий корзину для пользователя. Этот класс должен содержать список из
BasketItem
, а также дополнительное поле
total
— общую стоимость корзины. Класс также должен быть немодифицируемым, а его конструктор должен принимать в себя только список
BasketItem
.
Для подсчета общей стоимости используйте формулу: стоимость продукта × количество + стоимость продукта × количество и так далее. Попробуйте посчитать поле
total
с помощью StreamAPI.

После подготовки этих классов, вернитесь в
BasketService
и напишите метод
getUserBasket
, который возвращает корзину пользователя. Этот метод не должен ничего принимать и должен возвращать
UserBasket
.

Внутри метода
getUserBasket
вам нужно:

обратиться к компоненту корзины
ProductBasket
,
получить мапу товаров из корзины
и преобразовать ее в
UserBasket
.
В этом вам снова поможет StreamAPI и StorageSerivce.

Шаг 3. Методы контроллера
В контроллер вам нужно добавить два метода.

Метод добавления продукта в корзину —
@GetMapping(”/basket/{id}”)
. Этот метод должен возвращать строку вида “*Продукт успешно добавлен*”.
@GetMapping("/basket/{id}")
public String addProduct(@PathVariable("id") UUID id)
PathVariable — специальный аргумент, похожий на параметр запроса. Но в этом случае в качестве аргумента мы выделяем часть URL. То есть при запросе http://localhost:8080/shop/basket/d648c957-cad1-4b84-b953-62849f7a3806 в параметре id у нас окажется UUID вида d648c957-cad1-4b84-b953-62849f7a3806.

Метод отображения корзины.
@GetMapping("/basket")
public UserBasket getUserBasket()
Шаг 4. Проверка работоспособности
После того, как вы добавили методы и их реализации, проверьте все добавленные методы. Для этого:

Откройте страницу со всеми продуктами и создайте рядом новую вкладку в браузере.
В новой вкладке впишите адрес
http://localhost:8080/shop/basket/<ID из вкладки со всеми продуктами>
. Так вы добавите продукт в корзину.
После этого проверьте добавление с помощью запроса
http://localhost:8080/shop/basket
.
Добавьте несколько продуктов и убедитесь: если открывать новую вкладку в режиме инкогнито, то корзина в ней должна быть пустой.